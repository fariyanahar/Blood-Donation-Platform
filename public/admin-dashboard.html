<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Drive - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .navbar { 
            background-color: #dc3545;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .table-container {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .delete-btn {
            color: #dc3545;
            cursor: pointer;
        }
        .delete-btn:hover {
            color: #bb2d3b;
        }
        .filter-section {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="./admin-dashboard.html">Blood Drive</a>
            <div class="navbar-nav ms-auto">
                <a class="btn btn-outline-light me-2 fw-semibold" href="./create-event.html">Create Event</a>
                <a class="btn btn-outline-light me-2 fw-semibold" href="./events-admin.html">Manage Events</a>
                <a class="btn btn-outline-light me-2 fw-semibold" href="./post-admin.html">Manages Posts</a>
                <button class="btn btn-light fw-semibold" id="logoutBtn">Logout</button>
            </div>
        </div>
    </nav>


    <main class="container my-5">
        <h1 class="text-danger mb-4">Dashboard</h1>
        
        <div class="filter-section">
            <h4 class="mb-3">Filter Users</h4>
            <div class="row g-3">
                <div class="col-md-2">
                    <label class="form-label">Gender</label>
                    <select class="form-select" id="genderFilter">
                        <option value="">All</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Role</label>
                    <select class="form-select" id="roleFilter">
                        <option value="">All</option>
                        <option value="donor">Donor</option>
                        <option value="recipient">Recipient</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Address</label>
                    <select class="form-select" id="addressFilter">
                        <option value="">All</option>
                        <option value="Barishal">Barishal</option>
                        <option value="Chattogram">Chattogram</option>
                        <option value="Dhaka">Dhaka</option>
                        <option value="Khulna">Khulna</option>
                        <option value="Rajshahi">Rajshahi</option>
                        <option value="Rangpur">Rangpur</option>
                        <option value="Mymensingh">Mymensingh</option>
                        <option value="Sylhet">Sylhet</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Blood Type</label>
                    <select class="form-select" id="bloodTypeFilter">
                        <option value="">All</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Last Donation Date</label>
                    <input type="date" class="form-control" id="lastDonationFilter">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Birth Date</label>
                    <input type="date" class="form-control" id="birthDateFilter">
                </div>
            </div>
        </div>


        <div class="table-container">
            <h2 class="text-danger mb-4">Donors and Recipients</h2>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Gender</th>
                            <th>Role</th>
                            <th>Address</th>
                            <th>Blood Type</th>
                            <th>Last Donation</th>
                            <th>Birth Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Users will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>


    <script>
        function formatDate(dateString) {
            return dateString ? new Date(dateString).toLocaleDateString() : 'N/A';
        }


        function createUserRow(user) {
            return `
                <tr data-user-id="${user.id}">
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.phone}</td>
                    <td>${user.gender}</td>
                    <td>${user.role}</td>
                    <td>${user.address}</td>
                    <td>${user.blood_type}</td>
                    <td>${formatDate(user.last_donation_date)}</td>
                    <td>${formatDate(user.date_of_birth)}</td>
                    <td>
                        <i class="fas fa-trash delete-btn" onclick="deleteUser(${user.id})"></i>
                    </td>
                </tr>
            `;
        }


        async function fetchUsers() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = 'login.html';
                    return;
                }


                const filters = {};
                const gender = document.getElementById('genderFilter').value;
                const role = document.getElementById('roleFilter').value;
                const address = document.getElementById('addressFilter').value;
                const bloodType = document.getElementById('bloodTypeFilter').value;
                const lastDonation = document.getElementById('lastDonationFilter').value;
                const birthDate = document.getElementById('birthDateFilter').value;


                if (gender) filters.gender = gender;
                if (role) filters.role = role;
                if (address) filters.address = address;
                if (bloodType) filters.blood_type = bloodType;
                if (lastDonation) filters.last_donation_date = lastDonation;
                if (birthDate) filters.date_of_birth = birthDate;


                const response = await fetch('/api/user/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `${token}`
                    },
                    body: JSON.stringify({ filters })
                });


                if (response.ok) {
                    const result = await response.json();
                    const usersTableBody = document.getElementById('usersTableBody');
                    usersTableBody.innerHTML = result.data.map(user => createUserRow(user)).join('');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to load users');
            }
        }


        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) return;


            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/user', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `${token}`
                    },
                    body: JSON.stringify({ id: userId })
                });


                if (response.ok) {
                    document.querySelector(`tr[data-user-id="${userId}"]`).remove();
                    alert('User deleted successfully');
                } else {
                    alert('Failed to delete user');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to delete user');
            }
        }


        // Event Listeners
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        });


        // Add filter change listeners
        ['genderFilter', 'roleFilter', 'addressFilter', 'bloodTypeFilter', 
         'lastDonationFilter', 'birthDateFilter'].forEach(id => {
            document.getElementById(id).addEventListener('change', fetchUsers);
        });


        // Initial fetch
        document.addEventListener('DOMContentLoaded', fetchUsers);
    </script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

